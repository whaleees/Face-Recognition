<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .face-scan-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        .video-container {
            width: 640px;
            height: 480px;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const AuthPage = () => {
            const [email, setEmail] = useState('');
            const [isScanning, setIsScanning] = useState(false);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [stream, setStream] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [cameraDevices, setCameraDevices] = useState([]);
            const [selectedCamera, setSelectedCamera] = useState('');
            const [hasCameraPermission, setHasCameraPermission] = useState(false);
            const videoRef = useRef(null);

            // Modified device enumeration
            const initializeCameraDevices = async () => {
                try {
                    // Get temporary access
                    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    tempStream.getTracks().forEach(track => track.stop());

                    // Now get devices with labels
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(d => d.kind === 'videoinput');
                    setCameraDevices(videoDevices);
                    
                    if (videoDevices.length > 0) {
                        setSelectedCamera(videoDevices[0].deviceId);
                    }
                    setHasCameraPermission(true);
                } catch (error) {
                    console.error('Camera initialization failed:', error);
                    setError('Camera access is required for this feature');
                }
            };

            // Initialize on mount
            useEffect(() => {
                initializeCameraDevices();
            }, []);

            // Modified camera selection dropdown
            {hasCameraPermission && cameraDevices.length > 0 && (
                <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-medium mb-2">
                        Select Camera:
                        <select
                            value={selectedCamera}
                            onChange={(e) => setSelectedCamera(e.target.value)}
                            className="ml-2 p-2 border rounded"
                        >
                            {cameraDevices.map(device => (
                                <option key={device.deviceId} value={device.deviceId}>
                                    {device.label || `Camera ${device.deviceId.slice(0, 5)}`}
                                </option>
                            ))}
                        </select>
                    </label>
                </div>
            )}


            // Get available cameras
            useEffect(() => {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const videoDevices = devices.filter(d => d.kind === 'videoinput');
                        setCameraDevices(videoDevices);
                        if (videoDevices.length > 0) {
                            setSelectedCamera(videoDevices[0].deviceId);
                        }
                    });
            }, []);

            // Camera handling
            useEffect(() => {
                let mediaStream = null;

                const startCamera = async () => {
                    try {
                        mediaStream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                deviceId: selectedCamera,
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            }
                        });

                        videoRef.current.srcObject = mediaStream;
                        videoRef.current.play().catch(err => console.error("Video play error:", err));
                        setStream(mediaStream);
                    } catch (error) {
                        console.error('Camera Error:', error);
                        let errorMessage = 'Camera access denied';
                        if (error.name === 'NotAllowedError') {
                            errorMessage = 'Please allow camera access in browser settings';
                        } else if (error.name === 'NotFoundError') {
                            errorMessage = 'No camera detected';
                        } else if (error.name === 'NotReadableError') {
                            errorMessage = 'Camera already in use';
                        }
                        setError(errorMessage);
                        setIsScanning(false);
                    }
                };

                if (isScanning && selectedCamera) {
                    startCamera();
                }

                return () => {
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                        setStream(null);
                    }
                };
            }, [isScanning, selectedCamera]);

            const capturePhoto = async () => {
                const canvas = document.createElement('canvas');
                const video = videoRef.current;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                return new Promise((resolve) => {
                    canvas.toBlob(blob => {
                        resolve(blob);
                    }, 'image/jpeg');
                });
            };

            const handleFaceOperation = async () => {
                try {
                    setIsLoading(true);
                    setError('');
                    setSuccess('');

                    const photoBlob = await capturePhoto();

                    const formData = new FormData();
                    formData.append('image', photoBlob, 'face.jpg');

                    if(!email){
                        throw new Error('Please enter your email first');
                    }
                    formData.append('email', email.trim().toLowerCase());

                    const response = await fetch(`http://localhost:5000${isRegistering ? '/register' : '/recognize'}`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'Operation failed');

                    if (isRegistering) {
                        setSuccess('Registration successful!');
                        setTimeout(() => {
                            setIsRegistering(false);
                            setSuccess('');
                        }, 3000);
                    } else {
                        if (data.result && data.result !== "Unknown") {
                            setIsAuthenticated(true);
                        } else {
                            setError('Face not recognized');
                        }
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setIsLoading(false);
                    setIsScanning(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault(); // Prevent default form submission behavior
                setError(''); // Clear any previous error
                setSuccess(''); // Clear any previous success message

                // Check if the email is empty
                if (!email) {
                    setError('Email is required');
                    return;
                }

                // Validate email format
                if (!validateEmail(email)) {
                    setError('Please enter a valid email address');
                    return;
                }

                // Proceed with scanning if email is valid
                setIsScanning(true);
            };

            // Email validation function
            const validateEmail = (email) => {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            };


            const resetForm = () => {
                setEmail('');
                setIsScanning(false);
                setIsAuthenticated(false);
                setIsRegistering(false);
                setError('');
                setSuccess('');
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
            };

            if (isAuthenticated) {
                return (
                    <div className="min-h-screen flex items-center justify-center gradient-bg p-4">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center">
                            <div className="text-green-500 text-6xl mb-4">
                                <i className="fas fa-check-circle"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Welcome back!</h2>
                            <p className="text-gray-600 mb-6">You've been successfully authenticated</p>
                            <p className="text-gray-500 text-sm mb-6">Logged in as: {email}</p>
                            <button 
                                onClick={resetForm}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200"
                            >
                                Log out
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center gradient-bg p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i className="fas fa-user-shield text-blue-600 text-2xl"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">
                                {isRegistering ? 'Create Account' : 'Secure Login'}
                            </h1>
                            <p className="text-gray-600">
                                {isRegistering ? 'Register with your email and face' : 'Use your email and face recognition'}
                            </p>
                        </div>

                        {!isScanning ? (
                            <form onSubmit={handleSubmit}>
                                <div className="mb-6">
                                    <label htmlFor="email" className="block text-gray-700 text-sm font-medium mb-2">
                                        Email Address
                                    </label>
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i className="fas fa-envelope text-gray-400"></i>
                                        </div>
                                        <input
                                            type="email"
                                            id="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="your@email.com"
                                        />
                                    </div>
                                    {error && <p className="mt-2 text-sm text-red-600">{error}</p>}
                                    {success && <p className="mt-2 text-sm text-green-600">{success}</p>}
                                </div>

                                {cameraDevices.length > 0 && (
                                    <div className="mb-4">
                                        <label className="block text-gray-700 text-sm font-medium mb-2">
                                            Select Camera:
                                            <select
                                                value={selectedCamera}
                                                onChange={(e) => setSelectedCamera(e.target.value)}
                                                className="ml-2 p-2 border rounded"
                                            >
                                                {cameraDevices.map(device => (
                                                    <option key={device.deviceId} value={device.deviceId}>
                                                        {device.label || `Camera ${device.deviceId.slice(0, 5)}`}
                                                    </option>
                                                ))}
                                            </select>
                                        </label>
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center"
                                    disabled={isLoading}
                                >
                                    {isLoading ? (
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                    ) : (
                                        <i className={`fas ${isRegistering ? 'fa-user-plus' : 'fa-sign-in-alt'} mr-2`}></i>
                                    )}
                                    {isRegistering ? 'Register' : 'Continue'} with Face Recognition
                                </button>

                                <div className="mt-4 text-center">
                                    <button
                                        type="button"
                                        onClick={() => setIsRegistering(!isRegistering)}
                                        className="text-blue-600 hover:text-blue-800 text-sm"
                                    >
                                        {isRegistering 
                                            ? 'Already have an account? Login here'
                                            : 'Need an account? Register here'}
                                    </button>
                                </div>
                            </form>
                        ) : (
                            <div className="text-center">
                                <div className="mb-6">
                                    <h2 className="text-xl font-semibold text-gray-800 mb-2">
                                        {isRegistering ? 'Face Registration' : 'Face Recognition'}
                                    </h2>
                                    <p className="text-gray-600">Please look directly at your camera</p>
                                </div>

                                <div className="relative mb-6 video-container">
                                    <div className={`w-full h-full rounded-xl border-4 ${stream ? 'border-blue-500' : 'border-red-500'} overflow-hidden face-scan-animation`}>
                                        <video 
                                            ref={videoRef}
                                            autoPlay
                                            playsInline
                                            muted
                                            className="w-full h-full object-cover"
                                            style={{ transform: 'scaleX(-1)' }}
                                        />
                                    </div>
                                </div>
                                <button
                                    onClick={handleFaceOperation}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center"
                                    disabled={isLoading}
                                >
                                    {isLoading ? (
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                    ) : (
                                        <i className={`fas ${isRegistering ? 'fa-user-plus' : 'fa-sign-in-alt'} mr-2`}></i>
                                    )}
                                    {isRegistering ? 'Register Face' : 'Recognize Face'}
                                </button>
                                {success && (
                                    <div className="mt-4 p-3 bg-green-100 text-green-700 rounded-lg">
                                        {success}
                                    </div>
                                )}

                                {error && (
                                    <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg">
                                        {error}
                                    </div>
                                )}

                                <button
                                    onClick={resetForm}
                                    className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-200"
                                >
                                    <i className="fas fa-arrow-left mr-2"></i> Go Back
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => <AuthPage />;
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>